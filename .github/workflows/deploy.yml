name: ğŸš€ Deploy to Ncloud Server

on:
  push:
    branches:
      - main   # main ë¸Œëœì¹˜ push ì‹œ ìë™ ì‹¤í–‰

jobs:
  deploy:
    name: Deploy to Ncloud
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ§© Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ”‘ Connect & Deploy to Server
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: 175.45.194.202          # âœ… ì„œë²„ IP
          username: root                # âœ… ì ‘ì† ê³„ì •
          key: ${{ secrets.SSH_PRIVATE_KEY }}  # âœ… ê¹ƒí—ˆë¸Œ ì‹œí¬ë¦¿ì— ë“±ë¡í•œ ê°œì¸í‚¤ ì´ë¦„
          script: |
            echo "âœ… Connected to server"

            # 1ï¸âƒ£ ë ˆí¬ê°€ ì—†ìœ¼ë©´ í´ë¡ 
            if [ ! -d "/root/im-bank-n8n-agent" ]; then
              cd /root
              git clone https://github.com/jihun-moon/im-bank-n8n-agent.git
            fi

            # 2ï¸âƒ£ ìµœì‹  ì½”ë“œë¡œ ê°±ì‹ 
            cd /root/im-bank-n8n-agent
            git pull origin main

            # 3ï¸âƒ£ ë°±ì—”ë“œ ì—…ë°ì´íŠ¸ ë° ì‹¤í–‰
            cd backend
            npm install

            # PM2 ì„¤ì¹˜ (ì²˜ìŒ í•œ ë²ˆë§Œ)
            if ! command -v pm2 &> /dev/null; then
              npm install -g pm2
            fi

            # ê¸°ì¡´ í”„ë¡œì„¸ìŠ¤ ì¬ì‹œì‘ ë˜ëŠ” ìƒˆë¡œ ì‹œì‘
            if pm2 list | grep -q imbank-backend; then
              pm2 restart imbank-backend
            else
              pm2 start server.js --name imbank-backend
            fi

            pm2 save

            echo "ğŸš€ Backend deployed successfully!"
