name: ğŸš€ Auto Deploy to Ncloud Server (Full Setup)

on:
  push:
    branches:
      - main   # main ë¸Œëœì¹˜ì— pushí•  ë•Œ ì‹¤í–‰

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Full Auto Deployment

    steps:
      - name: ğŸ§© Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ”‘ Connect to Ncloud via SSH & Deploy
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: 175.45.194.202             # âœ… ì„œë²„ IP
          username: root                   # âœ… ê³„ì •
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "âœ… Connected to server"

            # 1ï¸âƒ£ í•„ìˆ˜ íŒ¨í‚¤ì§€ ì„¤ì¹˜ (git, curl, Node.js, npm, pm2)
            echo "ğŸ“¦ Installing dependencies if missing..."
            apt update -y
            apt install -y curl git

            if ! command -v node &> /dev/null; then
              echo "ğŸ”§ Installing Node.js..."
              curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
              apt install -y nodejs
            fi

            if ! command -v pm2 &> /dev/null; then
              echo "ğŸ”§ Installing pm2..."
              npm install -g pm2
            fi

            # 2ï¸âƒ£ ë ˆí¬ í´ë¡  or Pull
            if [ ! -d "/root/im-bank-n8n-agent" ]; then
              echo "ğŸŒ€ Cloning repository..."
              cd /root
              git clone https://github.com/jihun-moon/im-bank-n8n-agent.git
            fi

            cd /root/im-bank-n8n-agent
            git pull origin main

            # 3ï¸âƒ£ ë°±ì—”ë“œ ì„¤ì¹˜ ë° ì‹¤í–‰
            echo "ğŸš€ Setting up backend..."
            cd backend
            npm install

            if pm2 list | grep -q imbank-backend; then
              echo "â™»ï¸ Restarting backend..."
              pm2 restart imbank-backend
            else
              echo "ğŸŒ± Starting backend..."
              pm2 start server.js --name imbank-backend
            fi

            pm2 save
            echo "âœ… Backend is running at port 3001"

            # 4ï¸âƒ£ í”„ë¡ íŠ¸ì—”ë“œë„ ìë™ ë¹Œë“œ (ì„ íƒ)
            cd /root/im-bank-n8n-agent/frontend
            npm install
            npm run build || echo "âš ï¸ Frontend build skipped (optional)"

            echo "ğŸ‰ Deployment complete!"
