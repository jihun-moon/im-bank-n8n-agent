name: üöÄ Auto Deploy & NCP VPC Control (Lab + Keep Alive)

on:
  # 1) main Î∏åÎûúÏπòÏóê pushÎê† Îïå ÏûêÎèô Î∞∞Ìè¨
  push:
    branches:
      - main

  # 2) Ïä§ÏºÄÏ§Ñ ÏûëÏóÖ
  schedule:
    # Îß§Ïùº 00:00 UTC = 09:00 KST ‚Üí Ï†ïÏãú Í∏∞ÎèôÏö©
    - cron: "0 0 * * *"
    # 30Î∂ÑÎßàÎã§ ‚Üí keep-aliveÏö© (ÌóàÏö© ÏãúÍ∞Ñ ÎêòÏûêÎßàÏûê Î∞îÎ°ú ÏºúÏßÄÍ≤å)
    - cron: "*/30 * * * *"

  # 3) ÌïÑÏöîÌï† Îïå ÏàòÎèô Ïã§Ìñâ
  workflow_dispatch:


jobs:
  # ===============================
  # üîπ 1. ÏΩîÎìú Î≥ÄÍ≤Ω Ïãú ÏûêÎèô Î∞∞Ìè¨ Job
  # ===============================
  deploy:
    name: Full Auto Deployment
    runs-on: ubuntu-latest
    # üëâ push Ïù¥Î≤§Ìä∏ÏóêÏÑúÎßå ÎèôÏûë (schedule/ÏàòÎèô Ïã§Ìñâ ÎïåÎäî Î∞∞Ìè¨ Ïïà Ìï®)
    if: github.event_name == 'push'

    steps:
      - name: üß© Checkout Repository
        uses: actions/checkout@v4

      - name: üîë Connect to Ncloud via SSH & Deploy
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: 175.45.194.202             # ‚úÖ ÏÑúÎ≤Ñ IP
          username: root                   # ‚úÖ Í≥ÑÏ†ï
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "‚úÖ Connected to server"

            # 1Ô∏è‚É£ ÌïÑÏàò Ìå®ÌÇ§ÏßÄ ÏÑ§Ïπò (git, curl, Node.js, npm, pm2)
            echo "üì¶ Installing dependencies if missing..."
            apt update -y
            apt install -y curl git

            if ! command -v node &> /dev/null; then
              echo "üîß Installing Node.js..."
              curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
              apt install -y nodejs
            fi

            if ! command -v pm2 &> /dev/null; then
              echo "üîß Installing pm2..."
              npm install -g pm2
            fi

            # 2Ô∏è‚É£ Î†àÌè¨ ÌÅ¥Î°† or Pull
            if [ ! -d "/root/im-bank-n8n-agent" ]; then
              echo "üåÄ Cloning repository..."
              cd /root
              git clone https://github.com/jihun-moon/im-bank-n8n-agent.git
            fi

            cd /root/im-bank-n8n-agent
            git pull origin main

            # 3Ô∏è‚É£ Î∞±ÏóîÎìú ÏÑ§Ïπò Î∞è Ïã§Ìñâ
            echo "üöÄ Setting up backend..."
            cd backend
            npm install

            if pm2 list | grep -q imbank-backend; then
              echo "‚ôªÔ∏è Restarting backend..."
              pm2 restart imbank-backend
            else
              echo "üå± Starting backend..."
              pm2 start server.js --name imbank-backend
            fi

            pm2 save
            echo "‚úÖ Backend is running at port 3001"

            # 4Ô∏è‚É£ ÌîÑÎ°†Ìä∏ÏóîÎìúÎèÑ ÏûêÎèô ÎπåÎìú (ÏÑ†ÌÉù)
            cd /root/im-bank-n8n-agent/frontend
            npm install
            npm run build || echo "‚ö†Ô∏è Frontend build skipped (optional)"

            echo "üéâ Deployment complete!"


  # ===============================
  # üîπ 2. Îß§Ïùº 09:00 KST Ï†ïÏãú Í∏∞Îèô Job
  # ===============================
  start-vpc-server:
    name: Start NCP VPC Server (09:00 KST)
    runs-on: ubuntu-latest
    # üëâ Îß§Ïùº 0 0 * * * Ïä§ÏºÄÏ§ÑÏùº Îïå + ÏàòÎèô Ïã§ÌñâÏùº ÎïåÎßå
    if: github.event_name == 'workflow_dispatch' || (github.event_name == 'schedule' && github.event.schedule == '0 0 * * *')

    steps:
      - name: üïí Print info (KST ÎÇ†Ïßú Ï≤¥ÌÅ¨)
        run: |
          echo "UTC now:    $(date -u)"
          echo "KST (UTC+9): $(TZ=Asia/Seoul date)"

      - name: ‚òÅÔ∏è Start Naver Cloud VPC Server (Daily Boot)
        env:
          NCP_ACCESS_KEY: ${{ secrets.NCP_ACCESS_KEY }}
          NCP_SECRET_KEY: ${{ secrets.NCP_SECRET_KEY }}
          NCP_SERVER_INSTANCE_NO: ${{ secrets.NCP_SERVER_INSTANCE_NO }}
        run: |
          # üîí Ïã§Ïäµ Í≥ÑÏ†ï Ï†ÑÏ≤¥ Í∏∞Í∞Ñ Ï†úÌïú (2025-11-21 Ïù¥ÌõÑÏóî ÏûêÎèô Í∏∞Îèô X)
          END_DATE="2025-11-21"
          TODAY_KST=$(TZ=Asia/Seoul date +"%Y-%m-%d")

          if [[ "$TODAY_KST" > "$END_DATE" ]]; then
            echo "‚èπ Ïã§Ïäµ Í∏∞Í∞Ñ($END_DATE) ÏßÄÎÇ¨ÏúºÎØÄÎ°ú ÏûêÎèô ÏãúÏûë Í±¥ÎÑàÎúÄ"
            exit 0
          fi

          echo "üìÖ Ïò§Îäò(KST): $TODAY_KST, VPC ÏÑúÎ≤Ñ Ï†ïÏãú Í∏∞Îèô ÏãúÎèÑ"

          METHOD="GET"
          BASE_URL="https://ncloud.apigw.ntruss.com"
          REQUEST_PATH="/vserver/v2/startServerInstances"
          QUERY="serverInstanceNoList.1=${NCP_SERVER_INSTANCE_NO}"

          TIMESTAMP=$(($(date +%s%N)/1000000))
          MESSAGE="${METHOD} ${REQUEST_PATH}?${QUERY}\n${TIMESTAMP}\n${NCP_ACCESS_KEY}"

          SIGNATURE=$(echo -en "${MESSAGE}" \
            | openssl dgst -sha256 -hmac "${NCP_SECRET_KEY}" -binary | base64)

          echo "üîê Signature ÏÉùÏÑ± ÏôÑÎ£å, VPC API Ìò∏Ï∂ú ÏãúÏûë..."

          curl -G "${BASE_URL}${REQUEST_PATH}" \
            -d "${QUERY}" \
            -H "x-ncp-apigw-timestamp: ${TIMESTAMP}" \
            -H "x-ncp-iam-access-key: ${NCP_ACCESS_KEY}" \
            -H "x-ncp-apigw-signature-v2: ${SIGNATURE}" \
            -H "Content-Type: application/json" \
            -v


  # ===============================
  # üîπ 3. 30Î∂ÑÎßàÎã§ Keep-Alive Job
  #     ‚Üí Ïã§Ïäµ ÏãúÍ∞Ñ Î∞ñÏóêÏÑúÎèÑ Í≥ÑÏÜç ÏºúÎ≥¥Î†§Í≥† ÏãúÎèÑ
  # ===============================
  keep-alive:
    name: Keep NCP VPC Server Alive (Every 30min)
    runs-on: ubuntu-latest
    # üëâ 30Î∂Ñ Ïä§ÏºÄÏ§ÑÏùº Îïå + ÏàòÎèô Ïã§ÌñâÏùº ÎïåÎßå
    if: github.event_name == 'workflow_dispatch' || (github.event_name == 'schedule' && github.event.schedule == '*/30 * * * *')

    steps:
      - name: üîÅ Try to (Re)Start Naver Cloud VPC Server
        env:
          NCP_ACCESS_KEY: ${{ secrets.NCP_ACCESS_KEY }}
          NCP_SECRET_KEY: ${{ secrets.NCP_SECRET_KEY }}
          NCP_SERVER_INSTANCE_NO: ${{ secrets.NCP_SERVER_INSTANCE_NO }}
        run: |
          # üîí Ïã§Ïäµ Í∏∞Í∞Ñ Ï†ÑÏ≤¥ Î≤îÏúÑ Ï†úÌïú
          END_DATE="2025-11-21"
          TODAY_KST=$(TZ=Asia/Seoul date +"%Y-%m-%d")

          if [[ "$TODAY_KST" > "$END_DATE" ]]; then
            echo "‚èπ Ïã§Ïäµ Í∏∞Í∞Ñ($END_DATE) ÏßÄÎÇ¨ÏúºÎØÄÎ°ú keep-alive Ï§ëÎã®"
            exit 0
          fi

          echo "üïì [Keep-Alive] KST Today: $TODAY_KST - ÏÑúÎ≤Ñ (Ïû¨)Í∏∞Îèô ÏãúÎèÑ"

          METHOD="GET"
          BASE_URL="https://ncloud.apigw.ntruss.com"
          REQUEST_PATH="/vserver/v2/startServerInstances"
          QUERY="serverInstanceNoList.1=${NCP_SERVER_INSTANCE_NO}"

          TIMESTAMP=$(($(date +%s%N)/1000000))
          MESSAGE="${METHOD} ${REQUEST_PATH}?${QUERY}\n${TIMESTAMP}\n${NCP_ACCESS_KEY}"

          SIGNATURE=$(echo -en "${MESSAGE}" \
            | openssl dgst -sha256 -hmac "${NCP_SECRET_KEY}" -binary | base64)

          curl -G "${BASE_URL}${REQUEST_PATH}" \
            -d "${QUERY}" \
            -H "x-ncp-apigw-timestamp: ${TIMESTAMP}" \
            -H "x-ncp-iam-access-key: ${NCP_ACCESS_KEY}" \
            -H "x-ncp-apigw-signature-v2: ${SIGNATURE}" \
            -H "Content-Type: application/json" \
            -s -o /dev/stdout -w "\nHTTP Status: %{http_code}\n"

          echo "‚úÖ Keep-alive ping complete."
